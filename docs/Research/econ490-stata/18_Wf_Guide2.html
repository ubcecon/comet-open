<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-GB" xml:lang="en-GB"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ECON 490: Stata Workflow Guide (18) – COMET</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../media/comet_favicon.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<meta name="keywords" content="economics, econometrics, R, data, machine learning, UBC, COMET, geog 374, econ 325, econ 326, learning, teaching, learn r, r help, help, tutorial, r tutorial for beginners,learning statistics with r, learn r programming, learn statistics, linear regression, r machine learning, learn machine learning, university of british columbia, british columbia, r programming for beginners, r language tutorial, r tutorial for beginners, economic data, econometrics tutoring, economics help for students, economics homework help, oer resources for teachers, open educational resources for teachers, educational resource, oer project, oer materials, oer resources, learn economics online, learn econometrics, teach yourself economics, teach yourself econometrics, econometrics basics for beginners">


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../media/logo_no_tiny_text.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">COMET</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-get-started" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Get Started</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-get-started">    
        <li>
    <a class="dropdown-item" href="../../../pages/quickstart.html">
 <span class="dropdown-text">Quickstart Guide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/installation/installing_locally.html">
 <span class="dropdown-text">Install and Use COMET</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/index/index_getting_started.html">
 <span class="dropdown-text">Get Started</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-learn-by-skill-level" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Learn By Skill Level</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-learn-by-skill-level">    
        <li>
    <a class="dropdown-item" href="../../../pages/index/index_getting_started.html">
 <span class="dropdown-text">Getting Started</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/index/index_beginner.html">
 <span class="dropdown-text">Beginner</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/index/index_intermediate.html">
 <span class="dropdown-text">Intermediate - Econometrics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/index/index_geog.html">
 <span class="dropdown-text">Intermediate - Geospatial</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/index/index_advanced.html">
 <span class="dropdown-text">Advanced</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../../pages/index/all.html">
 <span class="dropdown-text">Browse All</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-learn-by-class" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Learn By Class</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-learn-by-class">    
        <li>
    <a class="dropdown-item" href="../../../pages/index/index_226.html">
 <span class="dropdown-text">Making Sense of Economic Data (ECON 226/227)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/index/index_325.html">
 <span class="dropdown-text">Econometrics I (ECON 325)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/index/index_326.html">
 <span class="dropdown-text">Econometrics II (ECON 326)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/index/index_geog.html">
 <span class="dropdown-text">Statistics in Geography (GEOG 374)</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-learn-to-research" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Learn to Research</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-learn-to-research">    
        <li>
    <a class="dropdown-item" href="../../../pages/index/index_research.html">
 <span class="dropdown-text">Learn How to Do a Project</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-teach-with-comet" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Teach With COMET</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-teach-with-comet">    
        <li>
    <a class="dropdown-item" href="../../../pages/teaching_with_comet.html">
 <span class="dropdown-text">Learn how to teach with Jupyter and COMET</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/using_comet.html">
 <span class="dropdown-text">Using COMET in the Classroom</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/dissemination/dissemination.html">
 <span class="dropdown-text">See COMET presentations</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-contribute" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Contribute</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-contribute">    
        <li>
    <a class="dropdown-item" href="../../../pages/installation/installing_for_development.html">
 <span class="dropdown-text">Install for Development</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/documentation/writing_self_tests.html">
 <span class="dropdown-text">Write Self Tests</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-launch-comet" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-play" role="img">
</i> 
 <span class="menu-text">Launch COMET</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-launch-comet">    
        <li>
    <a class="dropdown-item" href="https://open.jupyter.ubc.ca/jupyter/hub/user-redirect/git-pull?repo=https%3A%2F%2Fgithub.com%2Fubcecon%2Fcomet-project&amp;urlpath=lab%2Ftree%2Fcomet-project%2F&amp;branch=main"><i class="bi bi-cloud-check" role="img">
</i> 
 <span class="dropdown-text">Launch on JupyterOpen</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://ubc.syzygy.ca/jupyter/hub/user-redirect/git-pull?repo=https%3A%2F%2Fgithub.com%2Fubcecon%2Fcomet-project&amp;urlpath=lab%2Ftree%2Fcomet-project%2F&amp;branch=main"><i class="bi bi-gear" role="img">
</i> 
 <span class="dropdown-text">Launch on Syzygy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://colab.research.google.com/github/ubcecon/comet-project/blob/main/"><i class="bi bi-google" role="img">
</i> 
 <span class="dropdown-text">Launch on Collab</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ubcecon/comet-project/archive/refs/heads/main.zip"><i class="bi bi-cloud-download" role="img">
</i> 
 <span class="dropdown-text">Launch Locally</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="https://github.com/ubcecon/comet-project/archive/refs/heads/data-only.zip"><i class="bi bi-clipboard-data" role="img">
</i> 
 <span class="dropdown-text">Project Datasets</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../#"> 
<span class="menu-text">|</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-about" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">About</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-about">    
        <li>
    <a class="dropdown-item" href="../../../pages/team.html">
 <span class="dropdown-text">COMET Team</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/copyright.html">
 <span class="dropdown-text">Copyright Information</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link active" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#learning-outcomes" id="toc-learning-outcomes" class="nav-link" data-scroll-target="#learning-outcomes">Learning Outcomes</a></li>
  <li><a href="#introduction-to-workflow-management" id="toc-introduction-to-workflow-management" class="nav-link" data-scroll-target="#introduction-to-workflow-management">18.1 Introduction to Workflow Management</a></li>
  <li><a href="#setting-up-the-directory" id="toc-setting-up-the-directory" class="nav-link" data-scroll-target="#setting-up-the-directory">18.2 Setting Up the Directory</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ubcecon/comet-project/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ECON 490: Stata Workflow Guide (18)</h1>
</div>



<div class="quarto-title-meta column-page-left">

    
  
    
  </div>
  


</header>


<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<ol type="1">
<li>Knowledge of the content of the previous modules: macros, opening datasets, creating graphs, regression analysis.</li>
</ol>
</section>
<section id="learning-outcomes" class="level2">
<h2 class="anchored" data-anchor-id="learning-outcomes">Learning Outcomes</h2>
<ol type="1">
<li>Develop foundational skills and practices for workflow management in research and data applications.</li>
<li>Improve coding style, especially for collaborative settings.</li>
<li>Use the secure file-hosting service UBC One Drive to store, share, and synchronize folders.</li>
<li>Implement conditional operators to automate workflow processes.</li>
</ol>
<div class="alert alert-block alert-info">
<p>Significant credit for the content of the module must go to Asjad Naqvi and this very useful post on <a href="https://medium.com/the-stata-guide/the-stata-workflow-guide-52418ce35006">The Stata Guide on Medium</a></p>
</div>
</section>
<section id="introduction-to-workflow-management" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-workflow-management">18.1 Introduction to Workflow Management</h2>
<p>Structuring your files and folders early on can save you a lot of time and effort throughout your research project. The approach covered in this notebook will make it easier for you to keep track of your progress and reduce your workload. This approach will be particularly important if you are working in a group with several co-authors on one project.</p>
<p>In this module, we will discuss how to manage files and scripts as part of the research workflow. We will also cover how to stylize code to make it easy to read and replicate. While these are not strict rules, consider them guidelines for research and data management.</p>
</section>
<section id="setting-up-the-directory" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-directory">18.2 Setting Up the Directory</h2>
<section id="main-folder" class="level4">
<h4 class="anchored" data-anchor-id="main-folder">18.2.1 Main folder</h4>
<p>Over the course of the research project, you are likely to accumulate numerous files for our project, including raw data files, do-files, tables, graphs and figures. In fact, there are often many versions of each of these files. You should start by creating a main folder or a “root” folder where <em>all</em> your project files and folders are organized. If you are working with other people, consider creating these folders on a shared drive such as <a href="https://lthub.ubc.ca/guides/microsoft-onedrive-student-guide/">UBC Microsoft One Drive</a>. More on this in a moment.</p>
<p>Within the main folder, sort all your files into sub-folders similar to the structure shown below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/fig1-stata-dir.png" title="Main directory structure" class="img-fluid figure-img"></p>
<figcaption>Main directory structure</figcaption>
</figure>
</div>
<p>Each sub-folder consists of a specific category of files and is numbered to indicate the workflow:</p>
<ul>
<li><strong>data:</strong> contains all the data files</li>
<li><strong>do_files:</strong> contains all the Stata do-files used to process, clean and analyze the data files</li>
<li><strong>log_files:</strong> contains all the Stata log-files</li>
<li><strong>tables:</strong> contains all the regression tables, summary statistics, etc.</li>
<li><strong>figures:</strong> contains all the graphs and figures</li>
<li><strong>literature:</strong> contains papers and documents related to your literature review</li>
<li><strong>paper:</strong> contains word documents or LaTeX files relating to the written part of your paper</li>
<li><strong>slides:</strong> contains presentation slides</li>
</ul>
<div class="alert alert-block alert-info">
<p><b>Note:</b> Avoid spaces, special characters or capital letters in your folder or file names. If you need to use spaces, you can use underscores <code>_</code> . Consider numbering your files to indicate your workflow.</p>
</div>
</section>
<section id="do-files-folder" class="level4">
<h4 class="anchored">18.2.2 Do-files folder</h4>
<p>It’s almost never a good idea to use one do-file for your entire project. Instead, create different do-files for different tasks and add descriptive labels to reflect your workflow. As mentioned in the previous section, prefix your files with numbers to align with the workflow sequence.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/fig2-scripts.png" title="Example do-files" class="img-fluid figure-img"></p>
<figcaption>Scripts folder with example do-files</figcaption>
</figure>
</div>
<p>In the image above, the first do-file <code>1_build_data.do</code> cleans the raw data and generates core variables that will be used in subsequent scripts. The second do-file <code>2_descriptive.do</code> generates descriptive statistics and relevant figures. The third do-file <code>3_results.do</code> runs the final regressions and generates regression tables. The master do-file <code>0_master.do</code> runs all these other do-files. We will discuss its role in detail in a moment.</p>
<div class="alert alert-info">
<p>Note: Some researchers prefer to use different do-files for different figures and tables, which is completely fine as long as the files are labeled well. If you are generating different tables and figures within the same do-file, write them into separate code blocks within a do-file so that they can be easily distinguished.</p>
<section id="choosing-good-file-names" class="level4">
<h4 class="anchored" data-anchor-id="choosing-good-file-names">18.2.3 Choosing good file names</h4>
<p>While you are welcome to use your own naming conventions, it can be helpful to prefix your file names with numbers to align with your workflow; it is also a good idea to make these file names post-fixed with version numbers. Version numbers can be <code>_v1</code>, <code>_v2</code> (i.e.&nbsp;“ECON490_logfile_v12.txt”) or they can be indicated by dates (i.e.&nbsp;“ECON490_logfile_230430.txt”).</p>
<div class="alert alert-block alert-info">
<p><b>Note:</b> Following the yymmdd (year month date) format when using dates will automatically sort your files with the latest version at the top. Other date formats will not sort the files in the correct order and thus defeat the purpose of adding a post-fixed version number.</p>
</div>
<p>As you make progress with your project, you might find yourself collecting many versions of some of your files. As older versions become redundant, delete them or move them to a temporary folder. Creating a temporary folder for old do-files, tables, documents, etc. can be helpful in keeping your main folders neat if you are hesitant to delete them or if you are susceptible to digital hoarding (like many of us).</p>
</section>
<section id="setting-up-the-master-do-file" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-master-do-file">18.3 Setting up the Master do-file</h2>
<section id="compiling-do-files-with-the-master-do-file" class="level4">
<h4 class="anchored" data-anchor-id="compiling-do-files-with-the-master-do-file">18.3.1 Compiling do-files with the master do-file</h4>
<p>You can think of the master do-file <code>0_master.do</code> as a “compiler”: it runs all, or some, of the do-files for everything in your project. This Master do-file file should be structured something like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Project info */</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">clear</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Directory settings: paths to folders, defined as globals */</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Project settings: such as global variables and other macros */</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Run the do-files: runs all of the do-files for the project */</span> </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The master file begins with project information usually included in a block comment followed by the <code>clear</code> command. We then establish our <strong>directory settings</strong> and then <strong>project settings</strong>, both of which have been defined below. The final component of the script is to <strong>run the do-files</strong> in our project.</p>
<p>Each of these three components is discussed in turn below with the code that will be included in this master do-file.</p>
</section>
<section id="directory-settings" class="level4">
<h4 class="anchored" data-anchor-id="directory-settings">18.3.2 Directory settings</h4>
<p>Above, we indicated that our Master do-file will contain <strong>directory settings</strong>. Here is an example of what those should look like. These lines should be included in your master do file.</p>
<p>There are two essential tools utilized in this master file: 1. Relative file paths 2. Macros (i.e.&nbsp;locals and globals)</p>
<p>As we learned in <a href="econometrics/econ490-stata/4_Locals_and_Globals.ipynb">Module 4</a>, macros store information either temporarily with <code>local</code> objects or permanently with <code>global</code> objects. Locals store information within a code instance and disappear once the instance ends. Globals are stored in memory until you close Stata, hence they are considered “permanent”.</p>
<p>In this workflow example, we will define the key paths in globals.</p>
<ul>
<li>The unique name of your project is stored in the global called <em>proj_name</em>.</li>
<li>The path to your main folder (defined above) is stored in the global <em>proj_main</em>.</li>
<li>Each sub-directory’s path has its own globals; for example, the path to the data folder is called <em>data</em>. Note that we don’t need to specify the full file path for each sub-directory, as it would be already included in the main folder. For example, for the data folder, we can simply use <code>${proj_main}/data</code>.</li>
</ul>
<p>Here is an example. You will have to edit this information for your own project.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>*********************</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>* Directory Settings</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>*********************</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> proj_name <span class="st">"Fake Project"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> proj_main <span class="st">"$file_path/projects/${proj_name}"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> datadir <span class="st">"${proj_main}/data"</span>                  <span class="co">// Raw Files and Output from those</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> figdir <span class="st">"${proj_main}/figures"</span>                <span class="co">// Figure path</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> tabledir <span class="st">"${proj_main}/tables"</span>               <span class="co">// Tables Path</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> do_dir <span class="st">"${proj_main}/do_files"</span>                <span class="co">// Do-files path</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> log_dir <span class="st">"${proj_main}/logfiles"</span>              <span class="co">// Log-file path</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Setting up the directory using globals can be very useful. Imagine that in the do-file called <code>1_build_data.do</code> we want to load our data set saved under the file name <em>fake_data.csv</em> in the data folder <em>data</em> in a sub-directory called <em>raw</em>. Instead of defining the full file path of <em>fake_data.csv</em>, we can conveniently use our globals as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>import <span class="kw">delimit</span> <span class="kw">using</span> <span class="ot">${datadir}</span>/raw/fake_data.csv, <span class="kw">clear</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where we are telling Stata to go to the folder <em>raw</em> within the folder specified by the global <em>datadir</em> that we had defined earlier.</p>
</section>
<section id="run-the-do-files" class="level4">
<h4 class="anchored" data-anchor-id="run-the-do-files">18.3.3 Run the do-files</h4>
<p>The final component of the master do-file is the running of the do-files. Here you are given the simple example without using the project settings. The optional approach with those settings is further below.</p>
<p>As you know from <a href="econometrics/econ490-stata/2_Working_Dofiles.ipynb">Module 2</a>, we run a do-file by using the command <code>do</code> followed by the file path of the appropriate do-file.</p>
<p>For example, if we wanted to run the do-file that builds the data <code>1_build_data.do</code> that is stored in the folder indicated by the global <code>do_dir</code>, we would use the following command:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">do</span> <span class="st">"${do_dir}/1_build_data.do"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In our master do-file, we would include the code for running all the do-files like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>******************</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>* Run the <span class="kw">do</span>-files</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>******************</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">do</span> <span class="st">"${do_dir}/1_build_data.do"</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">do</span> <span class="st">"${do_dir}/2_descriptive.do"</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">do</span> <span class="st">"${do_dir}/3_results.do"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The master do-file simply runs all the project do-files in the appropriate order. Notice how the naming convention makes it easy to identify the sequence in which we need to run the do-files. File names are descriptive and sequentially numbered.</p>
</section>
<section id="using-ubc-microsoft-onedrive" class="level4">
<h4 class="anchored" data-anchor-id="using-ubc-microsoft-onedrive">18.3.4 Using UBC Microsoft OneDrive</h4>
<p>You have been asked to create a series of folders that will hold all of the information for your project. There are good reasons for keeping those folders on UBC OneDrive. You might, for example, want to be able to access that information when you are away from your computer (for example, working in a lab). You might (legitimately!!) be concerned that all of your hard work will be lost if your computer is damaged or stolen. Finally, you might be working on your project as part of a group - in which case file sharing will be necessary! Setting up OneDrive and installing the application on your own computer will resolve all of those issues.</p>
<p><a href="https://lthub.ubc.ca/guides/microsoft-onedrive-student-guide/">UBC Microsoft OneDrive</a> is a secure file-hosting service that allows you to store, share, and synchronize files and folders from any connected devices. You can learn how to store files on this service from the link provided above, but here we are going to cover how to access these files directly from Stata on any computer.</p>
<p>To begin, follow the instructions for your operating system to install the Microsoft OneDrive application on any computer that you want to work on. Once you complete this process, you will see that you have a new folder in your computer directory which contains all of the files in your OneDrive folder.</p>
<p>To see how this works, edit the command below to access that directory on your computer. You will need to determine the file path on your computer and edit the example path here. When you run this command, Stata will understand that it should use this directory moving forward. We have also included <code>dir</code> so that you can see your folders in that directory. If you have already set up the folders for your project, you will see them there.</p>
<div id="b8ecf6f0-e65c-4ee6-9c34-f23cb44e82c5" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cd <span class="st">"/Users/fake_user/Library/CloudStorage/OneDrive-UBC"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ot">dir</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now whenever you include the file paths in your globals or in your do-files you can point to your UBC OneDrive folders, and always have access to the most recent version of your work!</p>
</section>
</section>
<section id="best-practices-for-writing-code" class="level2">
<h2 class="anchored" data-anchor-id="best-practices-for-writing-code">18.4 Best Practices for Writing Code</h2>
<p>There are three core practices that will make it easy to write, edit and understand your code:</p>
<ol type="1">
<li>Adding comments.</li>
<li>Splitting up your code into multiple lines.</li>
<li>Indenting and spacing your code.</li>
</ol>
<section id="commenting" class="level4">
<h4 class="anchored" data-anchor-id="commenting">18.4.1 Commenting</h4>
<p>Leaving comments will not only help you remember what you have done, but it will help your group members, your TA and your instructor understand your thought process.</p>
<p>There are three ways to comment in a Stata do-file:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>* comments <span class="kw">on</span> individual lines</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">// comments on individual lines and after some code</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">comments on multiple lines</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">like a "code block"</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can also use a series of asterisks <code>*</code> to format your do file and partition your code. In the <code>0_master.do</code> example we saw earlier, the directory settings were highlighted as follows:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>********************</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>* Directory Settings</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>********************</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Formatting your do-file in this manner creates visual bookmarks and highlights different sections of your script.</p>
<p>Another use for comments is to “comment out” code that you might be testing or might need later. Use an asterisk to comment out a line:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>*<span class="kw">gen</span> log_earnings = <span class="fu">log</span>(earnings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Or comment out a block of code:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">label variable workerid "ID"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">la var treated "Treatment Dummy"</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">la var earnings "Earnings"</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">la var year "Calendar Year"</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Most importantly, leave comments before or after your code to explain what you did.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>* Open Raw Data</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>import <span class="kw">delimit</span> <span class="kw">using</span> <span class="st">"${datadir}/raw/fake_data.csv"</span>, <span class="kw">clear</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>la <span class="kw">var</span> birth_year <span class="st">"Year of Birth"</span> <span class="co">// label variable</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As we move on to writing more complex code, leaving comments will become more helpful.</p>
</section>
<section id="splitting-the-code-across-lines" class="level4">
<h4 class="anchored" data-anchor-id="splitting-the-code-across-lines">18.4.2 Splitting the code across lines</h4>
<p>In Stata, we can split code across multiple lines using three forward slashes <code>///</code>. This can be particularly useful when making graphs. Let’s see an example to understand why. Imagine we want to create a graph overlaying information for treated workers and untreated workers, such that they are marked with two different colors (we will see in details how to do this in <a href="econometrics/econ490-stata/9_Stata_Graphs.ipynb">Module 9</a>). The line of code to do it is:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">twoway</span> (connected log_earnings <span class="fu">year</span> <span class="kw">if</span> treated) || (connected log_earnings <span class="kw">if</span> !treated), <span class="kw">ylabel</span>(#8) <span class="kw">xlabel</span>(#10) <span class="bn">ytitle</span>(<span class="st">"Log-earnings"</span>) <span class="bn">xtitle</span>(<span class="st">"Year"</span>) <span class="bn">legend</span>( <span class="kw">label</span>(1 <span class="st">"Treated"</span>) <span class="kw">label</span>(2 <span class="st">"Control"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Making a graph has a lot of small components, all clustered together in a single line of code. If we had to go back and change the number of ticks for the x-axis <code>xlabel(#)</code>, it is safe to say it might take us a moment to parse through all this code.</p>
<p>Now, let’s format this code block using <code>///</code> to split it across multiple lines:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">twoway</span> <span class="co">///</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    (connected log_earnings <span class="fu">year</span> <span class="kw">if</span> treated) || (connected log_earnings <span class="fu">year</span> <span class="kw">if</span> !treated) , <span class="co">///</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ylabel</span>(#8)  <span class="kw">xlabel</span>(#10) <span class="co">///</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="bn">ytitle</span>(<span class="st">"Log-earnings"</span>) <span class="bn">xtitle</span>(<span class="st">"Year"</span>) <span class="co">///</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="bn">legend</span>( <span class="kw">label</span>(1 <span class="st">"Treated"</span>) <span class="kw">label</span>(2 <span class="st">"Control"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Is it easier for you to find <code>xlabel(#)</code> this time around?</p>
<p>Using <code>///</code> is a simple step we can take to make code blocks appear neat and legible.</p>
</section>
<section id="indent-and-space-your-code" class="level4">
<h4 class="anchored" data-anchor-id="indent-and-space-your-code">18.4.3 Indent and space your code</h4>
<p>Using indentations in your code and spacing it neatly can improve its readability with little effort. You can use the <code>tab</code> button on your keyboard to indent and organize your code. Let’s reformat the last example to see this in action.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">twoway</span>                                              <span class="co">///</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    (connected log_earnings <span class="fu">year</span> <span class="kw">if</span> treated)        <span class="co">///</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    ||                                              <span class="co">///</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    (connected log_earnings <span class="fu">year</span> <span class="kw">if</span> !treated)       <span class="co">///</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        ,                                           <span class="co">///</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ylabel</span>(#8)                                  <span class="co">///</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">xlabel</span>(#10)                                 <span class="co">///</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="bn">ytitle</span>(<span class="st">"Log-earnings"</span>)                      <span class="co">///</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="bn">xtitle</span>(<span class="st">"Year"</span>)                              <span class="co">///</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="bn">legend</span>(                                     <span class="co">///</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">label</span>(1 <span class="st">"Treated"</span>)                      <span class="co">///</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">label</span>(2 <span class="st">"Control"</span>)                      <span class="co">///</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is the same code block as before, but it is significantly easier to read this time around. Try to find <code>xlabel(#)</code> once again. Do you notice any difference?</p>
<p>You might not want to indent your code on such a granular level as shown in the example above. That’s okay, as long as the code is organized in a way that is clear to you and your collaborators and is generally easy to understand.</p>
</section>
<section id="putting-it-all-together" class="level4">
<h4 class="anchored" data-anchor-id="putting-it-all-together">18.4.4 Putting it all together</h4>
<p>Let’s review a final example which combines all the code styling tools we have discussed so far:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">twoway</span>                                              <span class="co">///</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    (connected log_earnings <span class="fu">year</span> <span class="kw">if</span> treated)        <span class="co">///     // log earnings, treated vs control group</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    ||                                              <span class="co">///</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    (connected log_earnings <span class="fu">year</span> <span class="kw">if</span> !treated)       <span class="co">///</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        ,                                           <span class="co">///</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ylabel</span>(#8)                                  <span class="co">///     // label ticks</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">xlabel</span>(#10)                                 <span class="co">///</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        <span class="bn">ytitle</span>(<span class="st">"Log-earnings"</span>)                      <span class="co">///     // axis titles</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="bn">xtitle</span>(<span class="st">"Year"</span>)                              <span class="co">///</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="bn">legend</span>(                                     <span class="co">///     // legend labels</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">label</span>(1 <span class="st">"Treated"</span>)                      <span class="co">///</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">label</span>(2 <span class="st">"Control"</span>)                      <span class="co">///</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The comments in this example might seem unnecessary since the code is self-explanatory. However, depending on your familiarity with Stata (or coding in general) and the complexity of the code, adding comments that seem obvious at the time can be helpful when you revisit your work days or weeks later. As students of economics, we understand that there is an opportunity cost to everything, including time spent deciphering code we have already written.</p>
</section>
</section>
<section id="more-on-project-settings-optional" class="level2">
<h2 class="anchored" data-anchor-id="more-on-project-settings-optional">18.5 More on Project Settings (optional)</h2>
<p>Our workflow can be simplified by defining project settings in the master do-file that determine which do-files are run and whether or not log files are generated. You can think of project settings as a series of switches that you can switch on and off in your work. For example, you could turn the switch to “off” for the do-file that builds the data when the data has already been fully processed and saved in your folder, or you could the switch to “on” to create a log file when you want to keep a record of the run of the do-file.</p>
<p>If you choose to include project settings in your master do-file, you will need to include specific lines of codes in the project settings and in the <em>run</em> settings of the master do-file, as well as in the <em>store_log</em> settings of specific do-files. We will see each of the three components below.</p>
<section id="project-settings" class="level4">
<h4 class="anchored" data-anchor-id="project-settings">18.5.1 Project settings</h4>
<p>For each step of the process settings, we will create globals to do the following:</p>
<ol type="1">
<li>Run globals that will switch on and off the running of the do-file (<code>run_build</code>, <code>run_descriptive</code>, <code>run_mainresults</code>)</li>
<li>Store globals that will switch on and off the creation of the log-file (<code>store_log_build</code>, etc.).</li>
</ol>
<p>These process settings will look like this:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>*******************</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>* Project Settings:</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>*******************</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>*Step 1: Build intermediate and final <span class="kw">data</span> <span class="kw">set</span> from raw <span class="kw">data</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> run_build = 1                <span class="co">// 0 = skip build step; 1 = run build.do</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> store_log_build = 1          <span class="co">// 0 = don't save log file; 1 = save log file</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>*Step 2: Run descriptive analysis</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> run_descriptive = 1          <span class="co">// 0 = skip; 1 = run</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> store_log_descriptive = 1    <span class="co">// 0 = don't save log file; 1 = save log file</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>*Step 3: Run main results (<span class="fu">e</span>.g. regressions)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> run_mainresults = 1          <span class="co">// 0 = skip; 1 = run</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> store_log_mainresults = 1    <span class="co">// 0 = don't save log file; 1 = save log file</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>At this stage, our settings don’t mean much; we have simply created globals and assigned them a specific value. When we reference these globals in our master do-file and in other do files, these settings will become meaningful. The values you choose to assign these globals will determine which actions occur and which don’t.</p>
<p><code>run</code> settings are referenced in two cases: 1. In the master do-file under the “run project” section. 2. In the beginning of the project do files, when required.</p>
<p><code>store_log</code> settings are referenced in two cases: 1. Always at the beginning of the project do-files (excluding the master do-file). 2. Always at the end of the project do-files (excluding the master do-file).</p>
<p>These will be discussed in more detail below.</p>
</section>
<section id="run-settings" class="level4">
<h4 class="anchored" data-anchor-id="run-settings">18.5.2 <em>run</em> settings</h4>
<p>Let’s consider how we might now run our do-files in the master do-file if we are using the <code>run</code> settings.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>******************</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>* Run the <span class="kw">do</span>-files</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>******************</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="ot">${run_build}</span>==1{</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">do</span> <span class="st">"${do_dir}/1_build_data.do"</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="ot">${run_descriptive}</span>==1{</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">do</span> <span class="st">"${do_dir}/2_descriptive.do"</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="ot">${run_mainresults}</span>==1{</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">do</span> <span class="st">"${do_dir}/3_results.do"</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is almost the same as the code block we saw earlier to run all our do-files. The key difference is that each command is nested within an <code>[if]</code> statement.</p>
<p>The <code>[if]</code> statements correspond to the global settings: IF the statement <code>${some_global}==1</code> is TRUE, THEN run the command in the curly brackets, which is <code>do "filename"</code>. Can you guess what happens if the statement is FALSE?</p>
<p>There’s one missing piece in this story. The comments in the settings say that assigning a value of <code>0</code> to a global skips that action. You may have noticed, however, that the <code>[if]</code> statement would return as FALSE for any value of <code>global run_build</code> as long as it is not equal to 1.</p>
<p>We could set <code>global run_build = 8</code> and Stata would still return the statement <code>${run_build}==1</code> as FALSE. The question remains: when does <code>0</code> become relevant?</p>
<p>To understand this, we have to think of our master do-file as a very long script that links all the other do-files together. Let’s consider a scenario where we want to skip the build step. This means our script begins with <code>2_descriptive.do</code>; however, <code>2_descriptive.do</code> includes commands to work with the data set we opened in <code>1_build_data.do</code>. Note that we don’t open the data set in the beginning of each do-file over and over again. This means we need to add a condition in the beginning of the <code>2_descriptive.do</code> script where we open the correct data set in the event we skip the first step.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="ot">${run_build}</span>==0 {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="st">"${datadir}/final/main_data.dta"</span>, <span class="kw">clear</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This clearly defines a situation where, if we skip the build data step, then we load the correct data set in Stata to run <code>2_descriptive.do</code> .</p>
<p>Similarly, if we were to skip the first two steps, then we would have to load the correct data set to run the results (i.e.&nbsp;step 3). We include the following command in the beginning of <code>3_results.do</code> to address this problem.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="ot">${run_build}</span>==0 &amp; <span class="ot">${run_descriptive}</span>==0 {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="st">"${datadir}/final/main_data.dta"</span>, <span class="kw">clear</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As you might have noticed, all scenarios where we skip a step are associated with <code>if ${some_global}==0</code>. As a result, we limit the values assigned to the global settings to 0 and 1.</p>
</section>
<section id="store_log-settings" class="level4">
<h4 class="anchored" data-anchor-id="store_log-settings">18.5.3 <em>store_log</em> settings</h4>
<p>Now let’s take a look at the <code>store_log</code> settings, which help us automate the process of storing log-files.</p>
<p>Imagine that all do-files except <code>0_master.do</code> include the <code>log</code> command in the beginning and end of the file. The <code>log</code> command is nested within an <code>[if]</code> statement related to the global settings, exactly like we saw earlier.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>*If <span class="fu">log</span> setting is activated, we record a <span class="fu">log</span> file <span class="kw">in</span> the <span class="fu">log</span> folder</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="ot">${store_log_descriptive}</span>==1 {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    cap <span class="fu">log</span> <span class="kw">close</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="kw">using</span> <span class="st">"${log_dir}/2_descriptive.log"</span>, <span class="kw">replace</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>.</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>.</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>.</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>*Close <span class="fu">log</span> <span class="kw">if</span> needed</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="ot">${store_log_descriptive}</span>==1 {</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    cap <span class="fu">log</span> <span class="kw">close</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>First, we start with an <code>[if]</code> statement which makes our global settings viable. Within the curly brackets we include <code>cap log close</code> to ensure that any open log-files from prior attempts are closed before we open the log-file. Then we use <code>log using "${log_dir}/2_descriptive.log", replace</code> which generates a log-file stored in the log directory <code>log_dir</code> (we defined this in the master file) and saves it under the name <code>2_descriptive.log</code>. Finally, at the end of the script we include a command to close the log-file.</p>
<p>We include this code within each of the do-files, only changing the <code>store_log</code> global and the name of the log-file to match the appropriate step.</p>
</section>
</section>
<section id="wrap-up" class="level2">
<h2 class="anchored" data-anchor-id="wrap-up">18.6 Wrap Up</h2>
<p>In this notebook, we looked at how to use UBC OneDrive to securely store projects. We explored how to structure a project directory, how to name files, and how to separate scripts. We also discussed important file types to include and best practices for coding more generally. Finally, we looked at how to use globals to improve the functionality of our master do-file.</p>
</section>
<section id="video-tutorial" class="level2">
<h2 class="anchored" data-anchor-id="video-tutorial">18.7 Video tutorial</h2>
<p>Click on the image below for a video tutorial on this module.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://learning.media.ubc.ca/media/Notebook+18+-+Workflow+Guide/0_5gnl0yfv"><img src="img/stata18.png" class="img-fluid figure-img" alt="Workflow Guide"></a></p>
<figcaption>Workflow Guide</figcaption>
</figure>
</div>


</section>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"></a>.  <a rel="license" href="https://comet.arts.ubc.ca/pages/copyright.html">See details.</a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ubcecon/comet-project/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 The COMET Project and the UBC Vancouver School of Economics are located on the traditional, ancestral and unceded territory of the xʷməθkʷəy̓əm (Musqueam) and Sḵwx̱wú7mesh (Squamish) peoples.
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>